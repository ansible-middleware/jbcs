---
- name: Include prereq trasks
  ansible.builtin.include_tasks: prereqs.yml

- name: Import firewalld tasks
  ansible.builtin.include_tasks: firewalld.yml
  when: configure_firewalld

- name: Import install tasks
  ansible.builtin.include_tasks: install.yml

- name: Import SSL configuration tasks
  ansible.builtin.include_tasks: ssl.yml

- name: "Ensures mod_cluster configuration is deployed"
  become: true
  ansible.builtin.template:
    src: templates/mod_cluster.conf.j2
    dest: "{{ httpd.home }}/httpd/conf.d/mod_cluster.conf"
    owner: "{{ httpd.user.name }}"
    group: "{{ httpd.group.name }}"
    mode: 0640
  when: mod_cluster_enable
  notify:
    - 'Expire mod_cluster cache and restart'

- name: "Start HTTPd Service"
  become: true
  ansible.builtin.service:
    name: "{{ service_name }}.service"
    state: started
    enabled: true

- name: "Wait for all used ports to be open"
  ansible.builtin.wait_for:
    port: "{{ item }}"
    delay: 2
  loop:
    - "{{ listen_port }}"
    - "{{ ssl_port }}"
    - "{{ mod_cluster_port }}"
  when:
    - port_check is defined and port_check
